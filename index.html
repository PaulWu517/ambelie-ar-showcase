<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambelie 柜子</title>
    <!-- 引入 Model Viewer -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        model-viewer {
            width: 100%;
            height: 100vh;
            background: #f5f5f5;
        }
        
        /* AR 按钮样式 - 强制显示在所有环境 */
        #ar-button {
            position: absolute !important;
            bottom: 30px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background: #007AFF !important;
            color: white !important;
            border: none !important;
            padding: 16px 32px !important;
            border-radius: 25px !important;
            font-size: 18px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.4) !important;
            transition: all 0.3s ease !important;
            z-index: 1000 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #ar-button:hover {
            background: #0056CC !important;
            transform: translateX(-50%) translateY(-2px) !important;
            box-shadow: 0 6px 25px rgba(0, 122, 255, 0.6) !important;
        }
        
        #ar-button:active {
            transform: translateX(-50%) translateY(0px) !important;
        }
        
        /* 加载状态 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            transition: opacity 0.5s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-text {
            font-size: 18px;
            color: #666;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #ar-button {
                bottom: 20px !important;
                padding: 14px 28px !important;
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <!-- 加载遮罩 -->
    <div class="loading-overlay" id="loading">
        <div class="loading-content">
            <div class="loading-text" id="loading-text">正在加载模型...</div>
            <div class="loading-progress" id="loading-progress" style="
                width: 200px;
                height: 4px;
                background: #e0e0e0;
                border-radius: 2px;
                margin: 15px auto;
                overflow: hidden;
                display: none;
            ">
                <div class="progress-bar" id="progress-bar" style="
                    width: 0%;
                    height: 100%;
                    background: #007AFF;
                    border-radius: 2px;
                    transition: width 0.3s ease;
                "></div>
            </div>
            <div class="loading-tips" id="loading-tips" style="
                font-size: 12px;
                color: #999;
                margin-top: 10px;
                line-height: 1.4;
            ">
                首次加载可能需要1-3分钟<br>
                请耐心等待...
            </div>
        </div>
    </div>
    
    <!-- Model Viewer 组件 -->
    <model-viewer
        id="model-viewer"
        alt="Ambelie中式柜子"
        src="https://ambelie-1368352639.cos.ap-guangzhou.myqcloud.com/guizi3%200917.glb"
        camera-controls
        touch-action="pan-y"
        auto-rotate
        ar
        ar-modes="webxr scene-viewer quick-look"
        environment-image="neutral"
        exposure="1.0"
        tone-mapping="neutral"
        shadow-intensity="0.8"
        loading="eager">
    </model-viewer>

    <!-- 统一AR按钮 - 适用于所有环境 -->
    <button id="universal-ar-button" style="
        position: fixed !important;
        bottom: 30px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        background: #007AFF !important;
        color: white !important;
        border: none !important;
        padding: 16px 32px !important;
        border-radius: 25px !important;
        font-size: 18px !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        box-shadow: 0 4px 20px rgba(0, 122, 255, 0.4) !important;
        z-index: 9999 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        transition: all 0.3s ease !important;
    ">
        在您的空间中查看
    </button>

    <script>
        const modelViewer = document.getElementById('model-viewer');
        const loadingOverlay = document.getElementById('loading');
        const universalArButton = document.getElementById('universal-ar-button');
        
        // 检测移动设备和浏览器
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
        }
        
        function isAndroid() {
            return /Android/i.test(navigator.userAgent);
        }
        
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
        
        function isChrome() {
            return /Chrome/i.test(navigator.userAgent) && !/Edge/i.test(navigator.userAgent);
        }
        
        function isSafari() {
            return /Safari/i.test(navigator.userAgent) && !/Chrome/i.test(navigator.userAgent);
        }
        
        // AR兼容性检测
        function checkARSupport() {
            const isSupported = {
                webxr: 'xr' in navigator && 'requestSession' in navigator.xr,
                sceneViewer: isAndroid() && isChrome(),
                quickLook: isIOS() && (isSafari() || isChrome()),
                general: isMobileDevice()
            };
            
            console.log('AR支持情况:', isSupported);
            return isSupported;
        }
        
        // 统一AR按钮点击处理
        function handleARClick() {
            console.log('AR按钮被点击');
            const arSupport = checkARSupport();
            
            if (arSupport.webxr || arSupport.sceneViewer || arSupport.quickLook) {
                // 尝试激活AR
                if (modelViewer.canActivateAR) {
                    modelViewer.activateAR();
                } else {
                    console.log('尝试手动触发AR');
                    const arEvent = new CustomEvent('activate-ar');
                    modelViewer.dispatchEvent(arEvent);
                }
            } else {
                // 不支持AR时的提示
                alert('您的设备或浏览器暂不支持AR功能。\n\n支持AR的环境：\n• Android Chrome浏览器\n• iOS Safari浏览器\n• iOS Chrome浏览器');
            }
        }
        
        // 加载进度和超时处理
        let loadingStartTime = Date.now();
        let loadingTimer = null;
        let progressTimer = null;
        
        // 模拟加载进度
        function updateLoadingProgress() {
            const loadingText = document.getElementById('loading-text');
            const loadingProgress = document.getElementById('loading-progress');
            const progressBar = document.getElementById('progress-bar');
            const loadingTips = document.getElementById('loading-tips');
            
            const elapsed = (Date.now() - loadingStartTime) / 1000; // 秒
            
            // 显示进度条
            if (elapsed > 5) {
                loadingProgress.style.display = 'block';
                const progress = Math.min(90, (elapsed - 5) / 180 * 90); // 3分钟内达到90%
                progressBar.style.width = progress + '%';
            }
            
            // 更新提示文字
            if (elapsed > 10) {
                loadingText.textContent = '模型较大，正在努力加载中...';
                loadingTips.innerHTML = '网络较慢时可能需要3-5分钟<br>建议切换到WiFi网络';
            } else if (elapsed > 30) {
                loadingText.textContent = '加载时间较长，请继续等待...';
                loadingTips.innerHTML = '如果超过5分钟仍未加载<br>请尝试刷新页面或检查网络';
            }
            
            // 超时处理
            if (elapsed > 300) { // 5分钟超时
                clearInterval(progressTimer);
                loadingText.textContent = '加载超时';
                loadingTips.innerHTML = `
                    <div style="color: #ff4444;">
                        加载时间过长，可能的原因：<br>
                        • 网络连接不稳定<br>
                        • VPN影响访问速度<br>
                        • 模型文件较大(${(25.5).toFixed(1)}MB)<br>
                        <button onclick="location.reload()" style="
                            margin-top: 10px;
                            padding: 8px 16px;
                            background: #007AFF;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        ">重新加载</button>
                    </div>
                `;
            }
        }
        
        // 开始加载进度更新
        function startLoadingProgress() {
            loadingStartTime = Date.now();
            progressTimer = setInterval(updateLoadingProgress, 1000);
        }
        
        // 初始化AR按钮
        function initializeARButton() {
            console.log('初始化统一AR按钮');
            const arSupport = checkARSupport();
            
            // 添加点击事件
            universalArButton.addEventListener('click', handleARClick);
            
            // 根据支持情况调整按钮文字
            if (!arSupport.general) {
                universalArButton.textContent = '查看3D模型（需移动设备支持AR）';
                universalArButton.style.fontSize = '14px';
                universalArButton.style.padding = '12px 24px';
            }
            
            console.log('AR按钮初始化完成');
        }
        
        // 监听模型加载完成
        modelViewer.addEventListener('load', function() {
            console.log('模型加载完成');
            console.log('模型信息:', {
                src: modelViewer.src,
                loaded: true,
                loadingTime: ((Date.now() - loadingStartTime) / 1000).toFixed(1) + '秒',
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            });
            
            // 清除进度定时器
            if (progressTimer) {
                clearInterval(progressTimer);
            }
            
            // 隐藏加载遮罩
            setTimeout(function() {
                loadingOverlay.classList.add('hidden');
                // 初始化AR按钮
                initializeARButton();
            }, 500);
        });
        
        // 监听模型加载错误
        modelViewer.addEventListener('error', function(event) {
            console.error('模型加载失败:', event);
            console.error('错误详情:', {
                type: event.type,
                detail: event.detail,
                target: event.target,
                timestamp: new Date().toISOString()
            });
            
            // 显示详细错误信息
            loadingOverlay.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="loading-text" style="color: #ff4444; margin-bottom: 15px;">
                        模型加载失败
                    </div>
                    <div style="font-size: 14px; color: #666; line-height: 1.5;">
                        可能的解决方案：<br>
                        • 检查网络连接是否稳定<br>
                        • 尝试关闭VPN后重新加载<br>
                        • 清除浏览器缓存后刷新<br>
                        • 切换到移动网络(4G/5G)尝试<br>
                        • 更换浏览器(Chrome/Safari)
                    </div>
                    <button onclick="location.reload()" style="
                        margin-top: 15px;
                        padding: 10px 20px;
                        background: #007AFF;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                    ">重新加载</button>
                </div>
            `;
        });
        
        // 监听 AR 状态
        modelViewer.addEventListener('ar-status', function(event) {
            console.log('AR状态:', event.detail.status);
            if (event.detail.status === 'session-started') {
                console.log('AR会话已启动');
            } else if (event.detail.status === 'not-presenting') {
                console.log('AR会话已结束');
            }
        });
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AR展示页面已就绪');
            
            // 开始加载进度跟踪
            startLoadingProgress();
            
            console.log('网络和设备信息:', {
                userAgent: navigator.userAgent,
                isMobile: isMobileDevice(),
                isAndroid: isAndroid(),
                isIOS: isIOS(),
                isChrome: isChrome(),
                isSafari: isSafari(),
                maxTouchPoints: navigator.maxTouchPoints,
                onLine: navigator.onLine,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'not available',
                timestamp: new Date().toISOString(),
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language
            });
            
            // 测试腾讯云COS连接
            console.log('开始测试模型文件连接...');
            fetch('https://ambelie-1368352639.cos.ap-guangzhou.myqcloud.com/guizi3%200917.glb', {
                method: 'HEAD',
                mode: 'cors'
            }).then(response => {
                console.log('模型文件连接测试结果:', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    ok: response.ok,
                    fileSize: response.headers.get('content-length') ? 
                        (parseInt(response.headers.get('content-length')) / 1024 / 1024).toFixed(1) + 'MB' : 
                        '未知大小'
                });
            }).catch(error => {
                console.error('模型文件连接测试失败:', error);
                console.error('可能的问题:', {
                    cors: '跨域访问被阻止',
                    network: '网络连接问题',
                    vpn: 'VPN可能影响访问',
                    dns: 'DNS解析问题',
                    firewall: '防火墙或网络限制'
                });
            });
            
            // 立即初始化AR按钮
            initializeARButton();
        });
    </script>
</body>
</html>